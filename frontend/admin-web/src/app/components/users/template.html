<div class="users-page">
<div class="container">
    <div class="page-header">
    <div>
        <h1>User Management</h1>
        <p>Manage users and their roles in Keycloak</p>
    </div>
    <button class="btn btn-primary" (click)="openCreateModal()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="12" y1="5" x2="12" y2="19"/>
        <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
        Add User
    </button>
    </div>

    <!-- Search Bar -->
    <div class="search-bar">
    <div class="search-input-wrapper">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"/>
        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
        </svg>
        <input
        type="text"
        class="form-control"
        placeholder="Search users by name or email..."
        [(ngModel)]="searchQuery"
        (ngModelChange)="onSearchChange($event)"
        />
    </div>
    <span class="results-count">{{ users.length }} users found</span>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-state">
    <div class="spinner"></div>
    <p>Loading users...</p>
    </div>

    <!-- Users Table -->
    <div class="card" *ngIf="!isLoading">
    <div class="table-container">
        <table class="table">
        <thead>
            <tr>
            <th>User</th>
            <th>Email</th>
            <th>Roles</th>
            <th>Status</th>
            <th>Created</th>
            <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <tr *ngFor="let user of filteredUsers">
            <td>
                <div class="user-cell">
                <div class="user-avatar">{{ getInitials(user.firstName, user.lastName, user.username) }}</div>
                <div class="user-info">
                    <span class="user-name">{{ user.firstName }} {{ user.lastName }}</span>
                    <span class="user-username">{{ '@' + user.username }}</span>
                </div>
                </div>
            </td>
            <td>{{ user.email }}</td>
            <td>
                <div class="roles-cell">
                <span *ngFor="let role of user.roles" class="role-badge" [class.admin]="role === 'admin'">
                    {{ role }}
                </span>
                <span *ngIf="user.roles.length === 0" class="no-roles">No roles</span>
                </div>
            </td>
            <td>
                <span class="badge" [class.badge-success]="user.enabled" [class.badge-error]="!user.enabled">
                {{ user.enabled ? 'Active' : 'Disabled' }}
                </span>
            </td>
            <td>{{ formatDate(user.createdTimestamp) }}</td>
            <td>
                <div class="action-buttons">
                <button class="btn btn-sm btn-secondary" (click)="openEditModal(user)" title="Edit">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                    </svg>
                </button>
                <button class="btn btn-sm btn-secondary" (click)="openPasswordModal(user)" title="Reset Password">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                </button>
                <button class="btn btn-sm btn-danger" (click)="confirmDelete(user)" title="Delete">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                </button>
                </div>
            </td>
            </tr>
            <tr *ngIf="filteredUsers.length === 0">
            <td colspan="6" class="empty-state">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                <p>No users found</p>
            </td>
            </tr>
        </tbody>
        </table>
    </div>
    </div>
</div>
</div>

<!-- Create/Edit User Modal -->
<div class="modal-overlay" *ngIf="showUserModal" (click)="closeUserModal()">
<div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
    <h3>{{ isEditMode ? 'Edit User' : 'Create New User' }}</h3>
    <button class="modal-close" (click)="closeUserModal()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"/>
        <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
    </button>
    </div>
    <div class="modal-body">
    <div *ngIf="modalError" class="alert alert-error">{{ modalError }}</div>
    
    <div class="form-row">
        <div class="form-group">
        <label class="form-label">First Name</label>
        <input type="text" class="form-control" [(ngModel)]="formData.firstName" placeholder="John">
        </div>
        <div class="form-group">
        <label class="form-label">Last Name</label>
        <input type="text" class="form-control" [(ngModel)]="formData.lastName" placeholder="Doe">
        </div>
    </div>

    <div class="form-group">
        <label class="form-label">Username *</label>
        <input type="text" class="form-control" [(ngModel)]="formData.username" placeholder="johndoe" [disabled]="isEditMode">
    </div>

    <div class="form-group">
        <label class="form-label">Email *</label>
        <input type="email" class="form-control" [(ngModel)]="formData.email" placeholder="john@example.com">
    </div>

    <div class="form-group" *ngIf="!isEditMode">
        <label class="form-label">Password *</label>
        <input type="password" class="form-control" [(ngModel)]="formData.password" placeholder="Enter password">
    </div>

    <div class="form-group">
        <label class="form-label">Roles</label>
        <div class="roles-select">
        <label *ngFor="let role of availableRoles" class="role-checkbox">
            <input type="checkbox" [checked]="formData.roles.includes(role.name)" (change)="toggleRole(role.name)">
            <span class="role-label">{{ role.name }}</span>
        </label>
        </div>
    </div>

    <div class="form-group">
        <label class="checkbox-label">
        <input type="checkbox" [(ngModel)]="formData.enabled">
        <span>User is enabled</span>
        </label>
    </div>

    <div class="form-group">
        <label class="checkbox-label">
        <input type="checkbox" [(ngModel)]="formData.emailVerified">
        <span>Email is verified</span>
        </label>
    </div>
    </div>
    <div class="modal-footer">
    <button class="btn btn-secondary" (click)="closeUserModal()">Cancel</button>
    <button class="btn btn-primary" (click)="saveUser()" [disabled]="isSaving">
        {{ isSaving ? 'Saving...' : (isEditMode ? 'Update User' : 'Create User') }}
    </button>
    </div>
</div>
</div>

<!-- Password Reset Modal -->
<div class="modal-overlay" *ngIf="showPasswordModal" (click)="closePasswordModal()">
<div class="modal modal-sm" (click)="$event.stopPropagation()">
    <div class="modal-header">
    <h3>Reset Password</h3>
    <button class="modal-close" (click)="closePasswordModal()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"/>
        <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
    </button>
    </div>
    <div class="modal-body">
    <p class="modal-info">Reset password for <strong>{{ selectedUser?.username }}</strong></p>
    
    <div *ngIf="modalError" class="alert alert-error">{{ modalError }}</div>
    <div *ngIf="modalSuccess" class="alert alert-success">{{ modalSuccess }}</div>
    
    <div class="form-group">
        <label class="form-label">New Password</label>
        <input type="password" class="form-control" [(ngModel)]="newPassword" placeholder="Enter new password">
    </div>
    
    <div class="form-group">
        <label class="form-label">Confirm Password</label>
        <input type="password" class="form-control" [(ngModel)]="confirmPassword" placeholder="Confirm new password">
    </div>

    <div class="form-group">
        <label class="checkbox-label">
        <input type="checkbox" [(ngModel)]="temporaryPassword">
        <span>Temporary password (user must change on next login)</span>
        </label>
    </div>
    </div>
    <div class="modal-footer">
    <button class="btn btn-secondary" (click)="closePasswordModal()">Cancel</button>
    <button class="btn btn-primary" (click)="resetPassword()" [disabled]="isSaving">
        {{ isSaving ? 'Resetting...' : 'Reset Password' }}
    </button>
    </div>
</div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" *ngIf="showDeleteModal" (click)="closeDeleteModal()">
<div class="modal modal-sm" (click)="$event.stopPropagation()">
    <div class="modal-header">
    <h3>Delete User</h3>
    <button class="modal-close" (click)="closeDeleteModal()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"/>
        <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
    </button>
    </div>
    <div class="modal-body">
    <div class="delete-warning">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="8" x2="12" y2="12"/>
        <line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        <p>Are you sure you want to delete <strong>{{ selectedUser?.username }}</strong>?</p>
        <p class="warning-text">This action cannot be undone.</p>
    </div>
    </div>
    <div class="modal-footer">
    <button class="btn btn-secondary" (click)="closeDeleteModal()">Cancel</button>
    <button class="btn btn-danger" (click)="deleteUser()" [disabled]="isSaving">
        {{ isSaving ? 'Deleting...' : 'Delete User' }}
    </button>
    </div>
</div>
</div>